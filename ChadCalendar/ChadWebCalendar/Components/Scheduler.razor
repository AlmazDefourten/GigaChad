@page "/scheduler"
@using ChadWebCalendar.Data
@using AntDesign;
@inject DialogService DialogService
@using ChadWebCalendar.Components.Events

<RadzenScheduler  @ref=@scheduler Data="@DataItems" TItem="DataItem" StartProperty="Start" EndProperty="End" TextProperty="Text" Style="height: 800px; width: 100%"
                 SlotSelect=@OnSlotSelect AppointmentSelect=@OnAppointmentSelect>
    <ChildContent>
        <RadzenWeekView />
        <RadzenDayView />
        <RadzenMonthView />
    </ChildContent>
</RadzenScheduler>

<Modal Title="@("Создание события")"
       Visible="@EventAddModal"
       OnOk="@HideModal"
       OnCancel="@HideModal"
       OkText="@("Ок")"
       CancelText="@("Закрыть")">
    <EventAdd></EventAdd>
</Modal>

<Modal Title="@("Изменить событие")"
       Visible="@EventEditModal"
       OnOk="@HideModal"
       OnCancel="@HideModal"
       OkText="@("Ок")"
       CancelText="@("Закрыть")">
    <EventEdit _eventId="@selectEventId"></EventEdit>
</Modal>

@code {
    class DataItem
    {
        public DateTime? Start { get; set; }
        public DateTime? End { get; set; }
        public string Text { get; set; }
        public int? Id { get; set; }
        public string Color { get; set; }
    }

    RadzenScheduler<DataItem> scheduler;
    ApplicationContext db = new ApplicationContext();

    [CascadingParameter] private Task<AuthenticationState> authenticationState { get; set; }

    public IEnumerable<Data.Event> GetEvents()
    {
        return db.Events.Where(e => e != null && e.User.Login == @authenticationState.Result.User.Identity.Name);
    }

    List<DataItem> DataItems = new();

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        foreach (var item in GetEvents())
        {
            DataItem d = new DataItem();
            d.Start = item.StartsAt;
            d.End = item.FinishesAt;
            d.Text = item.Name;
            d.Id = item.Id;

            DataItems.Add(d);
        }
    }

    private int myValue = 0;
    private int? selectEventId;

    private bool EventAddModal = false;
    private bool EventEditModal = false;

    private void ShowEventAddModal()
    {
        EventAddModal = true;
    }
    private void ShowEventEditModal()
    {
        EventEditModal = true;
    }

    private void HideModal()
    {
        EventAddModal = false;
        EventEditModal = false;
        scheduler.Reload();
    }

    private void OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        ShowEventAddModal();
        scheduler.Reload();
    }

    private void OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<DataItem> args)
    {
        selectEventId = args.Data.Id;
        ShowEventEditModal();
        scheduler.Reload();
    }
}
